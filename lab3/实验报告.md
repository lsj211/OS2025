# 拓展练习3：异常处理测试文档

## 1. 测试概述

### 测试目标
验证操作系统异常处理机制能够正确捕获和处理：
- **非法指令异常**（Illegal Instruction）
- **断点异常**（Breakpoint）

### 测试原理
通过内联汇编主动触发异常，验证异常处理程序能够：
- 正确识别异常类型
- 输出准确的异常信息
- 恢复程序正常执行

## 2. 测试代码

```c
void test_exceptions(void) {
    cprintf("\n===== Testing Exception Handlers =====\n");
    
    // 测试1: 非法指令异常
    cprintf("Test 1: Triggering illegal instruction exception...\n");
    asm volatile(".word 0x00000000\n"  // 明确的非法指令
                 "nop\n"               // 异常处理后继续执行
                 ::: "memory");
    
    cprintf("Illegal instruction test completed.\n\n");
    
    // 测试2: 断点异常  
    cprintf("Test 2: Triggering breakpoint exception...\n");
    asm volatile("ebreak\n"            // 断点指令
                 "nop\n"               // 异常处理后继续执行
                 ::: "memory");
    
    cprintf("Breakpoint test completed.\n\n");
    
    cprintf("===== All Exception Tests Finished =====\n\n");
}
```

## 3. 测试逻辑

### 3.1 测试流程
```
开始测试 → 触发异常 → 异常处理 → 验证输出 → 继续执行 → 完成测试
```

### 3.2 关键设计
- **`.word 0x00000000`**：明确的非法指令，强制触发异常
- **`ebreak`**：RISC-V标准断点指令
- **`nop`**：验证程序在异常处理后能继续执行
- **`::: "memory"`**：内存屏障，确保指令不被优化

## 4. 预期输出

```
===== Testing Exception Handlers =====
Test 1: Triggering illegal instruction exception...
Illegal instruction caught at 0x80200000
Exception type:Illegal instruction
Illegal instruction test completed.

Test 2: Triggering breakpoint exception...
ebreak caught at 0x80200004
Exception type: breakpoint
Breakpoint test completed.

===== All Exception Tests Finished =====
```

## 5. 验证要点

### 5.1 功能验证
- ✅ 非法指令异常被正确捕获
- ✅ 断点异常被正确捕获  
- ✅ 异常地址准确显示
- ✅ 异常类型正确标识
- ✅ 程序能够继续执行

### 5.2 异常处理机制
- **异常检测**：CPU自动检测非法指令和断点
- **上下文保存**：trapframe保存寄存器状态
- **异常分发**：根据cause字段路由到对应处理程序
- **指令跳过**：`epc += 4`跳过当前异常指令

## 6. 技术原理

### 6.1 异常触发机制
```c
// 非法指令：CPU遇到无法解码的指令
.word 0x00000000

// 断点指令：调试用途的显式断点
ebreak
```

### 6.2 处理恢复机制
```c
// 异常处理后跳过当前指令
tf->epc += 4;

// 继续执行下一条指令
nop
```

## 7. 总结

该测试通过主动触发异常验证了异常处理系统的：
- **正确性**：准确识别和处理两种异常类型
- **健壮性**：异常后程序能正常恢复执行
- **可用性**：提供清晰的调试信息输出

测试设计简单直接，能够有效验证异常处理核心功能。
